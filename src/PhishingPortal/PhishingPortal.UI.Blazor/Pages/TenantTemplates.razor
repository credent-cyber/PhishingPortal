@page "/tenant-templates"

@using PhishingPortal.Dto
@using PhishingPortal.UI.Blazor.Client
@using System.Text.RegularExpressions
@using Blazored.TextEditor

@inject TenantClient client
@inject ILogger<TenantCampaigns> logger

<h3>Campaign Templates</h3>



@if (Templates == null)
{
    <div class="loading-bar"></div>
}
else
{
    <div class="row">
        <div class="col-sm-10 col-lg-3 col-md-3">  <button class="btn btn-primary" @onclick="OnNewClick"><span class="oi oi-plus"></span></button></div>
    </div>
    <table class="table table-striped table-hover">
        <thead>
            <tr><th>Name</th><th>IsActive</th><th>IsHtml</th><th>CampaignType</th><th>Version</th><th>Preview</th></tr>
        </thead>
        <tbody>
            @foreach (var t in Templates)
            {
                <tr>
                    <td>
                        @t.Name
                    </td>
                    <td>@t.IsActive</td>
                    <td>@t.IsHtml</td>
                    <td>@t.Type</td>
                    <td>@t.Version</td>
                    <td><button type="button" @onclick="() => OnPreviewClick(t)" class="btn btn-outline-dark"><span class="oi oi-eye"></span></button></td>
                    <td><button type="button" @onclick="() => OnEditClick(t)" class="btn btn-outline-dark"><span class="oi oi-pencil"></span></button></td>
                </tr>
            }
        </tbody>
    </table>

}

<div class="edit-dialog-container">

    <DialogTemplate Show="showNewDialog" Title="@Title">

        @if (loading)
        {
            <div class="loading-bar"></div>
        }
        else
        {
            <Alerts IsError="@IsError" IsSuccess="@IsSuccess" Message=@Message></Alerts>
            <EditForm Model="@model" class="form" OnValidSubmit="OnSave">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label for="Name" class="form-label">Name Of Template</label>
                    <InputText id="Name" @bind-Value="model.Name" class="form-control" />
                </div>
                <div class="mb-3">
                    <InputCheckbox id="IsActive" @bind-Value="model.IsActive" class="form-check-input" />
                    <label for="IsActive" class="form-check-label">Is Active</label>
                </div>
                <div class="mb-3 form-check">
                    <InputCheckbox id="IsHtml" @bind-Value="model.IsHtml" class="form-check-input" />
                    <label for="IsHtml" class="form-check-label">Is Html</label>
                </div>
                <div class="mb-3">
                    <label for="Type" class="form-label">Campaign Type</label>
                    <InputSelect @bind-Value="model.Type" class="form-control" id="Type">
                        @foreach (var val in Enum.GetValues<CampaignType>())
                        {
                        <option value="@val">@val</option>
                        }
                </InputSelect>
            </div>
            <div class="mb-3">
                <label for="Content" class="form-label">Template Content</label>
                <!-- Rich text editor -->
                <BlazoredTextEditor @ref="@QuillHtml">
                    <ToolbarContent>
                        <select class="ql-header">
                            <option selected=""></option>
                            <option value="1"></option>
                            <option value="2"></option>
                            <option value="3"></option>
                            <option value="4"></option>
                            <option value="5"></option>
                        </select>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-image"></button>
                        </span>
                    </ToolbarContent>
                    <EditorContent>

                        @((MarkupString)model.Content)

                    </EditorContent>
                </BlazoredTextEditor>
                <div id="contentHelp" class="form-text">Content can be a rich text or html in case of email templates</div>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
            <button class="btn btn-secondary" @onclick="() => showNewDialog = false">Close</button>
        </EditForm>


        }


    </DialogTemplate>

</div>


<DialogTemplate Show="showPreview" Title="Template Preview">

    @previewContent

    <button @onclick="OnClosePreview">Close</button>

</DialogTemplate>

@code {

    [Parameter]
    public int Id { get; set; }

    public string Title
    {
        get
        {
            return model?.Id > 0 ? "Modify Template" : "Create New Template";
        }
    }
    string Message = string.Empty;
    bool IsError = false;
    bool IsSuccess = false;
    bool loading = false;

    bool showPreview = false;
    bool showNewDialog = false;
    string content = string.Empty;
    MarkupString previewContent => (MarkupString)content;

    List<CampaignTemplate> Templates;
    CampaignTemplate model;
    CampaignType? type = null;

    #region Blazore Text Editor

    BlazoredTextEditor QuillHtml;
    string QuillHTMLContent;

    public async Task GetHTML()
    {
        model.Content = await this.QuillHtml.GetHTML();
        StateHasChanged();
    }

    public async void SetHTML()
    {
        await this.QuillHtml.LoadHTMLContent(model.Content);

        StateHasChanged();
    }
    #endregion


    protected override async Task OnInitializedAsync()
    {
        Templates = await client.GetTemplatesByType(type);

    }

    public void OnValidSubmit()
    {

    }

    protected void OnPreviewClick(CampaignTemplate template)
    {
        showPreview = true;
        content = template.Content;
    }

    protected void OnClosePreview()
    {
        content = string.Empty;
        showPreview = false;
    }

    public void OnNewClick()
    {
        Message = string.Empty;
        model = new CampaignTemplate();
        model.Version = "1";
        showNewDialog = true;
    }

    public void OnEditClick(CampaignTemplate template)
    {
        Message = string.Empty;
        model = template;
        showNewDialog = true;
    }

    public async Task OnSave()
    {
        loading = true;

        try
        {
            if (model.Id > 0)
                Message = "Successfully Updated";
            else
                Message = "Successfully Added";

            await GetHTML();

            model = await client.UpsertCampaignTemplate(model);

            ///showNewDialog = false;
            IsSuccess = true;

            if (!Templates.Any(o => o.Id == model.Id))
                Templates.Add(model);
        }
        catch (Exception ex)
        {
            IsError = true;
            Message = ex.Message;
            logger.LogCritical(ex, ex.Message);
        }

        loading = false;

    }

}
