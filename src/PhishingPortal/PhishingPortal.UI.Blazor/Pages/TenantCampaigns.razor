@page "/tenant-campaigns"
@using PhishingPortal.Dto
@using PhishingPortal.UI.Blazor.Client
@using static PhishingPortal.Common.Constants
@using GridShared
@using GridShared.Utility
@using Microsoft.Extensions.Primitives
@using PhishingPortal.UI.Blazor.Pages.GridButtons
@using System.Text.Json
@using System.Text
@using PhishingPortal.UI.Blazor.Pages.GridComponent
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@inject AuthState authState;
@inject TenantClient client
@inject ILogger<TenantCampaigns> logger
@inject IJSRuntime JSRuntime
@inject Blazored.LocalStorage.ILocalStorageService oLocalStore
@attribute [Authorize]


<div class="page-header breadcumb-sticky">
    <div class="page-block">
        <div class="row align-items-center">
            <div class="col-md-12">
                <div class="page-header-title">
                    <h5 class="m-b-10 d-flex align-items-center">
                        Campaigns
                        <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModules="@AppModulesList" ReadOnly="true" IsButton="true">
                            @if (licencedViewRef?.CurrentMode == AccessMode.ReadWrite)
                            {
                                <a href="tenant-campaign-config"><i class="fa fa-plus-circle fa-lg ml-1" aria-hidden="true" title="Create Campaign"></i></a>
                            }
                            else
                            {
                                <a><i class="fa fa-plus-circle fa-lg" aria-hidden="true" title="Create Campaign"></i></a> 
                            }
                        </LicencedView>
                    </h5>
                </div>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/"><i class="feather icon-home"></i></a>
                    </li>
                    <li class="breadcrumb-item"><a>Campaigns</a></li>
                    <li class="breadcrumb-item"><a>All-Campaigns</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-sm-12 p-0">
        <div class="card-body p-2 mt-n3">
            <div class="bt-wizard" id="tabswizard">
                <ul class="nav nav-pills">
                    <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.EmailCampaign" ReadOnly="true" IsButton="false">
                        <li class="nav-item">
                            <a href="#tabs-t-tab1" @onclick="Emailc" class="nav-link rounded-0 @(CTab == 1 ? "active" : "")" data-toggle="tab">
                                <h6 class="m-0">Email</h6>
                            </a>
                        </li>
                    </LicencedView>
                    <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.SmsCampaign" ReadOnly="true" IsButton="false">
                        <li class="nav-item">
                            <a href="#tabs-t-tab2" @onclick="Smsc" class="nav-link rounded-0 @(CTab == 2 ? "active" : "")" data-toggle="tab">
                                <h6 class="m-0">SMS</h6>
                            </a>
                        </li>
                    </LicencedView>
                    <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.WhatsAppCampaign" ReadOnly="true" IsButton="false">
                        <li class="nav-item">
                            <a href="#tabs-t-tab3" @onclick="Whatsappc" class="nav-link rounded-0 @(CTab == 3 ? "active" : "")" data-toggle="tab">
                                <h6 class="m-0">WhatsApp</h6>
                            </a>
                        </li>
                    </LicencedView>
                </ul>

                <div class="tab-content card">
                    <div class="pt-1 bg-primary"></div>

                    <div class="tab-pane card-body pt-4 active show p-2" id="tabs-t-tab@CTab">
                        <div class="table-responsive">
                            @if (CTab == 1)
                            {
                                <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.EmailCampaign" ReadOnly="true">
                                    <EmailCampaignGrid />
                                </LicencedView>
                            }
                            @if (CTab == 2)
                            {
                                <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.SmsCampaign" ReadOnly="true">
                                    <SmsCampaignGrid />
                                </LicencedView>
                            }
                            @if (CTab == 3)
                            {
                                <LicencedView @ref="licencedViewRef" ShowLicenseWarning="false" AppModule="AppModules.WhatsAppCampaign" ReadOnly="true">
                                    <WhatsappCampaignGrid />
                                </LicencedView>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LicencedView licencedViewRef;
    public int CTab = 1;

    protected override async Task OnInitializedAsync()
    {
        CTab = await oLocalStore.GetItemAsync<int>("cTab");
        if (CTab == 0)
            CTab = 1;
    }

    public async Task SaveCampaignSession()
    {
        await oLocalStore.SetItemAsync("cTab", CTab);
    }

    public async Task Emailc()
    {
        CTab = 1;
        await SaveCampaignSession();
    }

    public async Task Smsc()
    {
        CTab = 2;
        await SaveCampaignSession();
    }

    public async Task Whatsappc()
    {
        CTab = 3;
        await SaveCampaignSession();
    }

    private List<AppModules> AppModulesList => new List<AppModules>
    {
        AppModules.EmailCampaign,
        AppModules.SmsCampaign,
        AppModules.WhatsAppCampaign
    };
}
